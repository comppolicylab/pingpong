name: Push PR code to AWS Staging
run-name: "Staging Test: Push ${{ github.event.issue.number }} on AWS"
permissions:
  contents: read
  checks: write
concurrency: release

on:
  issue_comment:
    types: [created]
jobs:
  release:
    name: Build and Push/Tag Docker Images for Testing
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/test-on-staging')
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release code at tag commit
        uses: actions/checkout@v6
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Get latest commit SHA
        run: echo "PR_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Create version tag
        run: |
          # Get the release tag
          RELEASE_TAG=${{ github.event.issue.number }}
          # Set GitHub environment variables
          echo "SRV_VERSION=pr_${RELEASE_TAG}" >> $GITHUB_ENV
          echo "WEB_VERSION=pr_${RELEASE_TAG}" >> $GITHUB_ENV
        shell: bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@6e631f05b2a5f53c9f1e27150d5e8af2f907b03b
        with:
          aws-access-key-id: ${{ secrets.PINGPONG_AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.PINGPONG_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@fe725d47d3009d901b44f3df285a6dc9d438e63a

      - name: Create Server Check Run
        if: contains(github.event.comment.body, 'server') || contains(github.event.comment.body, 'srv') || contains(github.event.comment.body, 'all')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
           gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f 'name=Server: Building & Pushing Image on AWS for Testing' \
            -f 'head_sha=${{ env.PR_SHA }}' \
            -f 'status=in_progress' \
            /repos/${{ github.repository }}/check-runs

      - name: Create Web Check Run
        if: contains(github.event.comment.body, 'web') || contains(github.event.comment.body, 'all')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
            gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f 'name=Web: Building & Pushing Image on AWS for Testing' \
            -f 'head_sha=${{ env.PR_SHA }}' \
            -f 'status=in_progress' \
            /repos/${{ github.repository }}/check-runs

      - name: Build server image for release
        if: contains(github.event.comment.body, 'server') || contains(github.event.comment.body, 'srv') || contains(github.event.comment.body, 'all')
        env:
          ENVIRONMENT: 'stage'
          SRV_VERSION: ${{ env.SRV_VERSION }}
        run: |
          echo "Building Server Image with tag ${{ env.SRV_VERSION }}"
          docker compose -f docker-compose.yml -f docker-compose.prod.yml build srv

      - name: Push server image for release
        if: contains(github.event.comment.body, 'server') || contains(github.event.comment.body, 'srv') || contains(github.event.comment.body, 'all')
        env:
          ENVIRONMENT: 'stage'
          SRV_VERSION: ${{ env.SRV_VERSION }}
        run: |
          aws ecr get-login-password --region ${{ vars.AWS_REGION }} | docker login --username AWS --password-stdin ${{ vars.PINGPONG_REGISTRY_ENDPOINT }}
          docker tag ${{ vars.PINGPONG_SRV_REGISTRY }}:${{ env.SRV_VERSION }} ${{ vars.PINGPONG_SRV_REGISTRY }}:${{ env.ENVIRONMENT }}
          docker push ${{ vars.PINGPONG_SRV_REGISTRY }}:${{ env.SRV_VERSION }}
          docker push ${{ vars.PINGPONG_SRV_REGISTRY }}:${{ env.ENVIRONMENT }}
          echo "Built and pushed Server Image (${{ env.SRV_VERSION }}) with ${{ env.ENVIRONMENT }} tag"

      - name: Complete Check Run (Server image pushed)
        if: contains(github.event.comment.body, 'server') || contains(github.event.comment.body, 'srv') || contains(github.event.comment.body, 'all')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
           gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f 'name=Server: Building & Pushing Image on AWS for Testing' \
            -f 'head_sha=${{ env.PR_SHA }}' \
            -f 'status=completed' \
            -f 'conclusion=success' \
            /repos/${{ github.repository }}/check-runs

      - name: Build web image for release
        if: contains(github.event.comment.body, 'web') || contains(github.event.comment.body, 'all')
        env:
          ENVIRONMENT: 'stage'
          WEB_VERSION: ${{ env.WEB_VERSION }}
        run: |
          echo "Building Web Image with tag ${{ env.WEB_VERSION }}"
          docker compose -f docker-compose.yml -f docker-compose.prod.yml build web

      - name: Push web image for release
        if: contains(github.event.comment.body, 'web') || contains(github.event.comment.body, 'all')
        env:
          ENVIRONMENT: 'stage'
          WEB_VERSION: ${{ env.WEB_VERSION }}
        run: |
          aws ecr get-login-password --region ${{ vars.AWS_REGION }} | docker login --username AWS --password-stdin ${{ vars.PINGPONG_REGISTRY_ENDPOINT }}
          docker tag ${{ vars.PINGPONG_WEB_REGISTRY }}:${{ env.WEB_VERSION }} ${{ vars.PINGPONG_WEB_REGISTRY }}:${{ env.ENVIRONMENT }}
          docker push ${{ vars.PINGPONG_WEB_REGISTRY }}:${{ env.WEB_VERSION }}
          docker push ${{ vars.PINGPONG_WEB_REGISTRY }}:${{ env.ENVIRONMENT }}
          echo "Built and pushed Web Image (${{ env.WEB_VERSION }}) with ${{ env.ENVIRONMENT }} tag"

      - name: Complete Check Run (Web image pushed)
        if: contains(github.event.comment.body, 'web') || contains(github.event.comment.body, 'all')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
           gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f 'name=Web: Building & Pushing Image on AWS for Testing' \
            -f 'head_sha=${{ env.PR_SHA }}' \
            -f 'status=completed' \
            -f 'conclusion=success' \
            /repos/${{ github.repository }}/check-runs
