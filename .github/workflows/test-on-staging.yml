name: Request PR deployment on AWS Staging
run-name: "Staging Request: PR #${{ github.event.issue.number }}"

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  pull-requests: read
  issues: write

jobs:
  request-staging-deploy:
    name: Route /test-on-staging command
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/test-on-staging') &&
      contains(fromJson('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Parse command flags
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import os
          import re

          body = os.environ.get("COMMENT_BODY", "")
          normalized = " ".join(body.split()).lower()

          # Split into whitespace-delimited tokens, strip leading dashes/slashes and trailing punctuation.
          tokens = set()
          for raw_token in normalized.split():
              cleaned = re.sub(r"^[\-/]+", "", raw_token)
              cleaned = re.sub(r"[^a-z0-9_-]", "", cleaned)
              if cleaned:
                  tokens.add(cleaned)

          force = "force" in tokens
          wants_web = "web" in tokens
          wants_srv = "server" in tokens or "srv" in tokens

          if "all" in tokens or (wants_web and wants_srv) or (not wants_web and not wants_srv):
              target = "all"
          elif wants_web:
              target = "web"
          else:
              target = "srv"

          print(f"target={target}")
          print(f"force={'true' if force else 'false'}")
          PY

      - name: Resolve PR head metadata
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_json="$(gh api "/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")"
          pr_sha="$(jq -r '.head.sha' <<<"$pr_json")"
          pr_repo="$(jq -r '.head.repo.full_name' <<<"$pr_json")"
          pr_is_fork="$(jq -r '.head.repo.fork' <<<"$pr_json")"

          echo "sha=${pr_sha}" >> "$GITHUB_OUTPUT"
          if [ "$pr_repo" != "${{ github.repository }}" ] || [ "$pr_is_fork" = "true" ]; then
            echo "is_blocked=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_blocked=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Block fork PR requests
        if: steps.pr.outputs.is_blocked == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -f "body=Staging deployment is blocked for fork PRs. Run this command from a branch in this repository."

      - name: Trigger staging deployment workflow
        if: steps.pr.outputs.is_blocked == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST "/repos/${{ github.repository }}/actions/workflows/staging-pr-build.yml/dispatches" \
            -f "ref=${{ github.event.repository.default_branch }}" \
            -f "inputs[pr_number]=${{ github.event.issue.number }}" \
            -f "inputs[pr_sha]=${{ steps.pr.outputs.sha }}" \
            -f "inputs[target]=${{ steps.parse.outputs.target }}" \
            -f "inputs[force]=${{ steps.parse.outputs.force }}" \
            -f "inputs[requested_by]=${{ github.actor }}" \
            -f "inputs[request_comment_id]=${{ github.event.comment.id }}"

      - name: Acknowledge staging request
        if: steps.pr.outputs.is_blocked == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -f "body=Queued staging deployment for \`${{ steps.parse.outputs.target }}\` at commit \`${{ steps.pr.outputs.sha }}\` (force: \`${{ steps.parse.outputs.force }}\`)."
